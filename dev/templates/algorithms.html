{% extends "Layout.html" %}
{% block content %}
<div>
    <h1 class="heading">{{ algorithm_set | upper }}</h1>
    <div class="container">
        <!-- Form to submit sorting options -->
        <form method="post" id="sorting-form">
            <!-- Display sorting method -->
            {% if sorting_way == 'name' %}
                <p>Sort algorithms by name</p>
            {% else %}
                <p>Sort algorithms by default</p>
            {% endif %}

            <!-- Sorting options -->
            <select id="sorting-select" name="sorting-select">
                <option value="">Select an option to sort algorithms</option>
                <option value="id">Default</option>
                <option value="name">Name</option>
            </select>
            <button type="submit">Submit</button>
        </form>
    </div>

    {% for image in images %}
        <div class="container">
            <!-- Display the algorithm name -->
            <p id="alg-name">Name: {{ image[0] }}</p>

            <!-- Display the algorithm image -->
            <img src="data:image/jpeg;base64,{{ image[1] }}" alt="Algorithm Image">

            <!-- Filter and display the algorithms -->
            {% for algs in algorithms %}
                {% if algs[1] == image[0] %}
          
                  <p id="algorithm"> {{ algs[3] }}</p>

                  <!-- Rating form -->
                  {% if 'username' in session %}
                  <div class="rating">
                      <form id="rating-form-{{ algs[0] }}" onsubmit="submitRating(event, '{{ algs[0] }}')">
                          <div class="form-group">
                              <label for="rating">Rate this algorithm:</label>
                              <input type="number" name="rating" min="0" max="5" step="1" required>
                          </div>
                          <button type="submit">Submit Rating</button>
                      </form>
                  </div>
                  {% endif %}

                  <!-- Average rating display -->
                  {% if algs[0] in ratings %}
                      <p class="rating-text" id="rating-display-{{ algs[0] }}">Average Rating: {{ ratings[algs[0]] }}</p>
                  {% else %}
                      <p class="rating-text" id="rating-display-{{ algs[0] }}">No Ratings Yet</p>
                  {% endif %}
                          {% endif %}
        
            {% endfor %}
        </div>
    {% endfor %}
</div>

<script>
    function submitRating(event, algorithmId) {
        event.preventDefault();

        // Set up XMLHttpRequest
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/algorithms/{{ algorithm_set }}", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

        // Get data from rating form
        var form = document.querySelector(`#rating-form-${algorithmId}`);
        var rating = form.querySelector('input[name=rating]').value;
        var data = 'algorithm_id=' + algorithmId + '&rating=' + rating;

        // Notify user to reload page to see new average rating
        xhr.onreadystatechange = function(){
            if (xhr.readyState == 4 && xhr.status == 200){
                document.getElementById("rating-display-" + algorithmId).innerHTML = "Rating Submitted! Reload to see new average rating.";
            }
        };
        
        // Send data to route.py and remove the form
        xhr.send(data);
        form.remove();
    }
</script>
{% endblock %}
